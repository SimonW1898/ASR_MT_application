# Streaming ASR→MT gRPC Demo (Application)

> Current demo support target: **Windows machines** (PowerShell scripts + FFmpeg DirectShow microphone path).

This repository provides a real-time ASR→MT demo with a clear client/server boundary:

- Client GUI in `grpc_demo/client` (PySide6) with WAV and microphone capture
- gRPC bidirectional streaming transport between client and server
- Server-owned segmentation, preprocessing, ASR, merge, MT, and JSONL logging
- Shared reusable pipeline components in `streaming`

## What this demo is for

- Show live speech-to-text (ASR) and translation (MT) in one UI
- Compare output quality against reference translations in WAV mode
- Run repeatable demos with cached models and offline runtime mode
- Provide a modular codebase for future model/policy experiments

## Documentation Hub

Use the docs wiki for all detailed guidance:

- [Docs Index](docs/index.md)
- [Runtime Guide](docs/runtime.md)
- [Scripts Guide](docs/scripts.md)
- [Data Guide](docs/data.md)
- [gRPC Demo Notes](docs/grpc_demo.md)

## Installation Handbook

For complete first-machine setup (PowerShell permissions, `venv311`, dependency install, preflight checks, cache prep, and run/stop flow), use:

- [Setup (Fresh Machine)](docs/setup_fresh_machine.md)

## FFmpeg Installation (Windows)

FFmpeg is required for microphone mode and environment preflight checks.

Option A (winget):

```powershell
winget install --id Gyan.FFmpeg --exact
```

Option B (Chocolatey):

```powershell
choco install ffmpeg -y
```

Option C (manual):

1. Download a Windows FFmpeg build (zip).
2. Extract to a stable folder (for example `C:\tools\ffmpeg`).
3. Add `C:\tools\ffmpeg\bin` to your system/user `PATH`.
4. Open a new terminal.

Verify installation:

```powershell
ffmpeg -hide_banner -version
```

Then run preflight:

```powershell
./check_env.ps1
```

## Startup

Quick start (opens server and GUI in separate terminals):

```powershell
./run_grpc_demo.ps1
```

Stop everything started by launcher (server + GUI + fallback process cleanup):

```powershell
./stop_grpc_demo.ps1
```

If port `50051` is occupied:

```powershell
./run_grpc_demo.ps1 -KillExistingPortProcess
```

Manual two-terminal startup (same environment):

```powershell
# Terminal 1
.\venv311\Scripts\python.exe -m grpc_demo.server.server_main

# Terminal 2
.\venv311\Scripts\python.exe -m grpc_demo.client.app --config grpc_demo/configs/demo.yaml
```

## Tooling Data Root (dev-only scripts)

Minimal data workflow (current):

```powershell
.\venv-eval\Scripts\python.exe .\scripts\data_manage\download_cvss_raw.py --languages ar,de,fa,ja --min_matches 10 --max_per_split 500 --seed 123 --common_voice_tar .\cv-corpus-24.0-2025-12-05-ar.tar.gz
```

Outputs:

- `application/data/raw/cvss_st/<src>-en/clips/*`
- `application/data/raw/cvss_st/<src>-en/metadata/train.jsonl`
- `application/data/raw/cvss_st/<src>-en/metadata/validation.jsonl`
- `application/data/raw/cvss_st/<src>-en/metadata/test.jsonl`

For full step-by-step data setup, see [docs/data.md](docs/data.md).

## Repository Structure

```text
application/
├─ README.md
├─ requirements-py311.txt
├─ run_grpc_demo.ps1
├─ stop_grpc_demo.ps1
├─ check_env.ps1
├─ prepare_model_cache.ps1
├─ scripts/
├─ docs/
├─ grpc_demo/
├─ streaming/
├─ data/
└─ logs/
```

### Folder-by-folder guide

- `docs/`
	- Main documentation hub and stable wiki pages
	- Start at [docs/index.md](docs/index.md)
	- Folder-level README files are intentionally removed; docs live only under `docs/`

- `scripts/` (tooling only, non-shipped)
	- Internal data/eval utilities separated from runtime
	- `data_manage/`: CVSS/CommonVoice raw build + stream_with_meta builders
	- `eval/`: evaluation helpers
	- Full guide: [docs/scripts.md](docs/scripts.md)

- `grpc_demo/`
	- Demo-specific application layer
	- `client/`: PySide6 GUI, WAV/mic sources, gRPC client flow
	- `server/`: gRPC service, segmentation/processing, model manager, logging
	- `configs/`: runtime YAML + model cache plan
	- `proto/` and `proto_gen/`: protobuf source and generated stubs

- `streaming/`
	- Reusable pipeline components shared by demo/server
	- ASR, MT, buffering/merge, preprocess, core abstractions

- `data/stream/`
	- WAV demo assets and optional sidecar JSON references
	- Sidecar JSON (same base filename) powers reference translation window in GUI

- `logs/`
	- JSONL run outputs generated by server sessions

- `model_cache/`
	- Local Hugging Face snapshots for offline/portable demo runs

- `md_old/`
	- Legacy source docs kept as historical reference input

- `venv311/`
	- Local Python 3.11 virtual environment (machine-local)

### Root scripts and what they do

- `run_grpc_demo.ps1`
	- Starts server and GUI in separate terminals
	- Supports `-KillExistingPortProcess` for stale binds

- `stop_grpc_demo.ps1`
	- Stops tracked terminals and fallback server/client processes
	- Clears listener leftovers on port `50051` when found

- `check_env.ps1`
	- Verifies Python path, imports, FFmpeg, config file, and port state

- `prepare_model_cache.ps1`
	- Reads model plan and warms ASR/MT models for offline demo stability

## Documentation

- [Docs Index](docs/index.md)
- [Runtime Guide](docs/runtime.md)
- [Setup (Fresh Machine)](docs/setup_fresh_machine.md)
- [Configuration](docs/configuration.md)
- [Model Cache Strategy](docs/model_cache.md)
- [Script Reference](docs/scripts.md)
- [Data Guide](docs/data.md)
- [gRPC Demo Notes](docs/grpc_demo.md)
- [Troubleshooting](docs/troubleshooting.md)
